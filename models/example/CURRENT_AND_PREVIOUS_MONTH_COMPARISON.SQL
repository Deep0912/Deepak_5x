
/*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/

{{ config(materialized='table') }}

with source_data as (

  select START_OF_THE_MONTH,
SUM(TOTAL_CASES) TOTAL_CASES,
SUM(PREV_MONTH_TOTAL_CASES) PREV_MONTH_TOTAL_CASES,
SUM(TOTAL_ACTIVE_CASES)  TOTAL_ACTIVE_CASES ,
SUM(PREV_MONTH_TOTAL_ACTIVE_CASES)  PREV_MONTH_TOTAL_ACTIVE_CASES,
SUM(NEW_CASES) NEW_CASES, SUM(PREV_MONTH_NEW_CASES) PREV_MONTH_NEW_CASES,
SUM(TOTAL_RECOVERED) TOTAL_RECOVERED , SUM(PREV_MONTH_TOTAL_RECOVERED)  PREV_MONTH_TOTAL_RECOVERED,

SUM(NEW_RECOVERED)  NEW_RECOVERED,SUM(PREV_MONTH_NEW_RECOVERED)  PREV_MONTH_NEW_RECOVERED,SUM(NEW_DEATHS)  NEW_DEATHS ,
SUM(PREV_MONTH_NEW_DEATHS)  PREV_MONTH_NEW_DEATHS,
SUM(TOTAL_DEATHS)  TOTAL_DEATHS, SUM(PREV_MONTH_TOTAL_DEATHS)  PREV_MONTH_TOTAL_DEATHS,
SUM(NEW_ACTIVE_CASES)  NEW_ACTIVE_CASES,SUM(PREV_MONTH_NEW_ACTIVE_CASES)  PREV_MONTH_NEW_ACTIVE_CASES
from 
(select date_trunc('MONTH',cast(DATE as date)) START_OF_THE_MONTH,SUM(TOTAL_CASES)  TOTAL_CASES,0   PREV_MONTH_TOTAL_CASES,SUM(TOTAL_ACTIVE_CASES)  TOTAL_ACTIVE_CASES,0  PREV_MONTH_TOTAL_ACTIVE_CASES, SUM(NEW_CASES) NEW_CASES , 0 PREV_MONTH_NEW_CASES,
SUM(TOTAL_RECOVERED) TOTAL_RECOVERED, 0 PREV_MONTH_TOTAL_RECOVERED,
SUM(NEW_RECOVERED)  NEW_RECOVERED, 0  PREV_MONTH_NEW_RECOVERED,SUM(NEW_DEATHS)  NEW_DEATHS,0  PREV_MONTH_NEW_DEATHS,
SUM(TOTAL_DEATHS)  TOTAL_DEATHS,0  PREV_MONTH_TOTAL_DEATHS,SUM(NEW_ACTIVE_CASES)  NEW_ACTIVE_CASES, 0  PREV_MONTH_NEW_ACTIVE_CASES
from FIVETRAN_INTERVIEW_DB.GOOGLE_SHEETS.COVID_19_INDONESIA_DEEPAK_SINGHAL
group by START_OF_THE_MONTH

union
select DATEADD(month,1,date_trunc('MONTH',cast(DATE as date))) START_OF_THE_MONTH,0  TOTAL_CASES ,SUM(TOTAL_CASES)  PREV_MONTH_TOTAL_CASES,0  TOTAL_ACTIVE_CASES ,SUM(TOTAL_ACTIVE_CASES)  PREV_MONTH_TOTAL_ACTIVE_CASES,0 NEW_CASES , SUM(NEW_CASES) PREV_MONTH_NEW_CASES,
0 TOTAL_RECOVERED, SUM(TOTAL_RECOVERED)  PREV_MONTH_TOTAL_RECOVERED,
 0  NEW_RECOVERED,
SUM(NEW_RECOVERED)  PREV_MONTH_NEW_RECOVERED,0  NEW_DEATHS ,SUM(NEW_DEATHS)  PREV_MONTH_NEW_DEATHS,
0  TOTAL_DEATHS,SUM(TOTAL_DEATHS)  PREV_MONTH_TOTAL_DEATHS,0  NEW_ACTIVE_CASES,SUM(NEW_ACTIVE_CASES)  PREV_MONTH_NEW_ACTIVE_CASES
from FIVETRAN_INTERVIEW_DB.GOOGLE_SHEETS.COVID_19_INDONESIA_DEEPAK_SINGHAL
group by START_OF_THE_MONTH)
X
group by START_OF_THE_MONTH
order by START_OF_THE_MONTH

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
